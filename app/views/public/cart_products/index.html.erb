<main>
  <div class="cart-box">
    <div class="container">
      <h3>ショッピングカート</h3>
      <p><%= link_to "カートを空にする", cart_products_path, method: :delete, data: { confirm: "本当にカートを空にしますか？" }, class="btn btn-sm btn-danger"  %></p>
    </div>

    <% @cart_products.each do |cart_product|%>
      <table>
        <thead>
          <tr>
            <th colspan="3">商品名</th>
            <th>単価(税込)</th>
            <th>数量</th>
            <th>小計</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>
              <%= attachment_image_tag cart_product.product, :image, :fill, 40, 40 %>
              <%= cart_product.product.name %>
            </td>
            <td>
              <%= cart_product.product.name %>
            </td>
            <td>
              <%= (cart_product.product.ex_price * @tax).floor %>
            </td>
            <td>
              <%= form_with url: cart_product_path, local:true do |f| %>
                <%= f.select :quantity,
                  {"1":1, "2":2, "3":3, "4":4, "5":5, "6":6, "7":7, "8":8, "9":9, "10":10},
                  { include_blank: cart_product.quantity }
                %>
              <% end %>
            </td>
            <td>
              <%= (cart_product.product.ex_price * @tax * cart_product.quantity).floor %>
            </td>
            <td>
              <%= link_to "削除する", cart_product_path, method: :delete, data: { confirm: "本当にカートを空にしますか？" }, class="btn btn-sm btn-danger" %>
            </td>
          </tr>
        </tbody>
      </table>

      <!--合計金額算出-->
      <% sum = 0 %>
      <% sub_total = (cart_product.product.ex_price * @tax * cart_product.quantity).floor %>
      <% sum + = sub_total %>
    <% end %>

    <div class="container">
      <%= link_to "買い物を続ける", root_path, class:"btn btn-sm btn-primary" %>
      <tbody>
        <tr>
          <td>合計金額</td>
          <td><%= sum %></td>
        </tr>
      </tbody>
    </div>
  </div>
</main>